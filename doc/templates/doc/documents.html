{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>Управление документами</h2>
    <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
        Загрузить новый документ
    </button>

    <!-- Модальное окно для загрузки документа -->
    <div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadDocumentModalLabel">Загрузка документа</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadDocumentForm" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="id_title" class="form-label">Название документа</label>
                            <input type="text" class="form-control" id="id_title" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="id_file" class="form-label">Файл</label>
                            <input type="file" class="form-control" id="id_file" name="file" required>
                        </div>
                        <div class="mb-3">
                            <label for="id_practice" class="form-label">Практика</label>
                            <select class="form-select" id="id_practice" name="practice" required>
                                <option value="">Выберите практику</option>
                                {% for practice in practices %}
                                    <option value="{{ practice.id }}">{{ practice.pp }} {{ practice.pm }} {{ practice.preddiplom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-dark" onclick="uploadDocument()">Загрузить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Список документов -->
    <div class="mt-4">
        <h3>Документы</h3>
        <div id="documentsList" style="overflow-y: auto; max-height: 400px;">
            {% for document in documents %}
                <div class="card mb-2">
                    <div class="card-body">
                        <h5 class="card-title">{{ document.title }}</h5>
                        <p class="card-text">
                            Практика: {{ document.practice.pp }} {{ document.practice.preddiplom }}<br>
                            Группы: {{ document.practice.groups.all|join:", " }}
                        </p>
                        <a href="{{ document.file.url }}" class="btn btn-primary">Скачать</a>
                        <button type="button" class="btn btn-danger" onclick="deleteDocument({{ document.id }})">Удалить</button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // Функция для загрузки документа
    function uploadDocument() {
        const form = document.getElementById('uploadDocumentForm');
        const formData = new FormData(form);

        fetch("{% url 'upload_document_ajax' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload(); // Перезагружаем страницу для обновления списка
            } else {
                alert('Ошибка: ' + data.errors);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
        });
    }

    // Функция для удаления документа
    function deleteDocument(documentId) {
        if (confirm('Вы уверены, что хотите удалить этот документ?')) {
            fetch(`/delete_document_ajax/${documentId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload(); // Перезагружаем страницу для обновления списка
                } else {
                    alert('Ошибка: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
            });
        }
    }
</script>
{% endblock %}